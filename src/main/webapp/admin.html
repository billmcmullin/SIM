<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Console</title>
  <style>body{font-family:Arial;margin:20px} label{display:block;margin:6px 0} input{padding:8px;width:400px}</style>
</head>
<body>
  <h3>Admin Console</h3>
  <div><strong id="who"></strong> <button id="btnLogout">Logout</button></div>

  <div id="setupArea">
    <h4>Database Configuration</h4>
    <div>
      <label>JDBC URL<input id="jdbc" placeholder="jdbc:postgresql://host:5432/db"></label>
      <label>DB User<input id="dbuser"></label>
      <label>DB Password<input id="dbpass" type="password"></label>
      <label>Driver Class<input id="driver" value="org.postgresql.Driver"></label>
      <button id="btnTest">Test Connection</button>
      <button id="btnConnect">Save & Connect</button>
      <div id="dbmsg"></div>
    </div>
  </div>

  <div id="adminArea" style="display:none">
    <h4>Create User</h4>
    <div>
      <label>Username<input id="newuser"></label>
      <label>Password<input id="newpass" type="password"></label>
      <label>Role<select id="newrole"><option>USER</option><option>ADMIN</option></select></label>
      <button id="btnCreateUser">Create User</button>
      <div id="usermsg"></div>
    </div>

    <h4>Sync</h4>
    <div>
      <label>Scope<input id="syncscope" value="all"></label>
      <button id="btnSync">Trigger Sync</button>
      <div id="syncmsg"></div>
    </div>
  </div>

  <script>
    // Generic API helper
    async function api(path, opts={}) {
      opts.headers = opts.headers || {};
      const token = localStorage.getItem('jwt');
      if (token) opts.headers['Authorization'] = 'Bearer ' + token;
      opts.headers['Accept'] = 'application/json';
      const r = await fetch(path, opts);
      const txt = await r.text();
      let j = null;
      try { j = txt ? JSON.parse(txt) : null; } catch(e){}
      if (!r.ok) throw { status: r.status, body: j || txt };
      return j;
    }

    document.getElementById('btnLogout').onclick = () => { localStorage.clear(); location.href='index.html'; };

    document.getElementById('btnTest').onclick = async () => {
      const cfg = {jdbcUrl: document.getElementById('jdbc').value, username: document.getElementById('dbuser').value, password: document.getElementById('dbpass').value, driverClass: document.getElementById('driver').value};
      document.getElementById('dbmsg').textContent = 'Testing...';
      try {
        await api('api/admin/db/test', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(cfg)});
        document.getElementById('dbmsg').textContent = 'Test succeeded';
      } catch (e) {
        document.getElementById('dbmsg').textContent = 'Test failed: ' + (e.body?.error || e.status);
      }
    };

    document.getElementById('btnConnect').onclick = async () => {
      const cfg = {jdbcUrl: document.getElementById('jdbc').value, username: document.getElementById('dbuser').value, password: document.getElementById('dbpass').value, driverClass: document.getElementById('driver').value};
      document.getElementById('dbmsg').textContent = 'Connecting & running migrations...';
      try {
        await api('api/admin/db/connect', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(cfg)});
        document.getElementById('dbmsg').textContent = 'Connected and migrations executed';
        // After connect, show the admin-only area (refresh UI state)
        showAdminAreaIfAuthorized();
      } catch (e) {
        document.getElementById('dbmsg').textContent = 'Connect failed: ' + (e.body?.error || e.status);
      }
    };

    document.getElementById('btnCreateUser').onclick = async () => {
      const payload = {username: document.getElementById('newuser').value, password: document.getElementById('newpass').value, role: document.getElementById('newrole').value};
      document.getElementById('usermsg').textContent = 'Creating...';
      try {
        await api('api/admin/users', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        document.getElementById('usermsg').textContent = 'User created';
      } catch (e) {
        document.getElementById('usermsg').textContent = 'Create failed: ' + (e.body?.error || e.status || e);
      }
    };

    document.getElementById('btnSync').onclick = async () => {
      const scope = document.getElementById('syncscope').value;
      document.getElementById('syncmsg').textContent = 'Syncing...';
      try {
        await api('api/admin/sync', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({scope})});
        document.getElementById('syncmsg').textContent = 'Sync started';
      } catch (e) {
        document.getElementById('syncmsg').textContent = 'Sync failed: ' + (e.body?.error || e.status);
      }
    };

    // Decide UI mode on load
    (async function init() {
      try {
        const s = await api('api/admin/db/status');
        if (s && s.configured === false) {
          // DB not configured: show only setup area and hide adminArea
          document.getElementById('setupArea').style.display = 'block';
          document.getElementById('adminArea').style.display = 'none';
          document.getElementById('who').textContent = 'Setup mode (not logged in)';
          return;
        }
      } catch (e) {
        // if status check fails, fallback to showing setup area
        console.warn('db status check failed', e);
      }

      // If we reach here DB is configured: show admin area only if logged in as ADMIN
      showAdminAreaIfAuthorized();
    })();

    function showAdminAreaIfAuthorized() {
      const role = (localStorage.getItem('role') || '').toUpperCase();
      const user = localStorage.getItem('username') || '';
      if (role !== 'ADMIN') {
        // not an admin: redirect to dashboard or login
        if (!localStorage.getItem('jwt')) {
          alert('Please log in as admin');
          location.href = 'index.html';
        } else {
          alert('You must be an ADMIN to view this page. Redirecting to dashboard.');
          location.href = 'dashboard.html';
        }
        return;
      }
      // admin: show admin area
      document.getElementById('setupArea').style.display = 'none';
      document.getElementById('adminArea').style.display = 'block';
      document.getElementById('who').textContent = 'Logged in as: ' + user;
    }
  </script>
</body>
</html>
