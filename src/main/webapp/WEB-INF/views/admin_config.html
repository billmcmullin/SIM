<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Admin Configuration</title>
    <link rel="stylesheet" href="${contextPath}/assets/css/app.css">
</head>

<body>
    <div class="top-bar">
        <div class="top-bar-inner">
            <div class="brand">Chat Server Admin</div>
            <div>
                <span>Signed in as <strong>${user}</strong></span>
                <a href="${contextPath}/profile"> Profile </a>
                <a href="${contextPath}/dashboard"> Dashboard </a>
                <a href="${contextPath}/logout"> Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <section class="section">
            <h1>Admin Configuration</h1>
            <p>Hello, ${user}. Configure the chat server connection below.</p>
            <p><a href="${contextPath}/dashboard">&larr; Back to Dashboard</a></p>
        </section>

        <section class="section">
            <h2>Server Configuration</h2>
            <form id="serverConfigForm">
                <div class="form-group">
                    <label for="serverHost">Server Host</label>
                    <input type="text" id="serverHost" name="serverHost" placeholder="https://chat-server.example.com"
                        value="${serverHost}" required>
                </div>
                <div class="form-group">
                    <label for="serverPort">Server Port</label>
                    <input type="number" id="serverPort" name="serverPort" placeholder="9090" value="${serverPort}"
                        required>
                </div>
                <div class="form-group">
                    <label for="apiKey">API Key</label>
                    <input type="password" id="apiKey" name="apiKey" placeholder="Enter API key to set or replace">
                    <div class="small-note">
                        <span id="apiKeyStoredNote" style="display:none;">An API key is already stored. Leave blank to
                            keep it.</span>
                    </div>
                </div>
                <div class="actions">
                    <button type="button" id="testConnectionBtn">Test Connection</button>
                    <button type="button" id="saveConfigBtn" disabled>Save Configuration</button>
                </div>
                <div id="testResult" style="font-weight:600; color:#047857; margin-top:12px;"></div>
            </form>
        </section>

        <section class="section">
            <h2>Workspace Management</h2>
            <form id="workspaceForm">
                <div class="form-group">
                    <label for="workspaceNameInput">Workspace Name</label>
                    <input type="text" id="workspaceNameInput" name="workspaceName"
                        placeholder="e.g. North America Support" value="${workspaceName}">
                </div>
                <div class="actions">
                    <button type="button" id="saveWorkspaceBtn">Save Workspace Name</button>
                </div>
                <div id="workspaceMessage" class="widget-message"></div>
            </form>
        </section>


        <section class="section widget-section">
            <h2>Widget Registry</h2>
            <div class="search-row">
                <input type="text" id="widgetSearch" placeholder="Search widget ID or name">
                <button type="button" id="searchWidgetsBtn">Search</button>
                <button type="button" id="clearWidgetSearchBtn">Clear</button>
            </div>
            <div class="widget-controls">
                <div>
                    <label for="widgetIdInput">Widget ID</label>
                    <input type="text" id="widgetIdInput" placeholder="Enter widget identifier">
                </div>
                <div>
                    <label for="widgetNameInput">Widget Name</label>
                    <input type="text" id="widgetNameInput" placeholder="Friendly name">
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="button" id="saveWidgetEntryBtn" style="width:100%;">Save Widget</button>
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="button" id="clearWidgetFormBtn" style="width:100%;">Clear Form</button>
                </div>
            </div>
            <div id="widgetMessage" class="widget-message" style="color:#047857;"></div>
            <div style="overflow-x:auto;">
                <table class="widget-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="widgetSelectAll"></th>
                            <th>Widget ID</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="widgetTableBody">
                        <tr>
                            <td colspan="4" class="empty-row">Loading widget entries…</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="actions">
                <button type="button" id="deleteSelectedWidgetsBtn">Delete Selected</button>
            </div>
        </section>

        <section class="section">
            <h2>Widget Table Explorer</h2>
            <p>This section lists every widget ID from the registry, ensures their tables exist, and syncs embedded
                chat content.</p>
            <div class="actions">
                <button type="button" id="syncWidgetTablesBtn">Sync Widget Tables</button>
            </div>
            <div class="automated-sync">
                <h3>Automatic Sync Timer</h3>
                <div class="form-group">
                    <label for="syncInterval">Sync Interval (minutes)</label>
                    <input type="number" id="syncInterval" min="1" placeholder="Enter interval">
                </div>
                <div class="actions">
                    <button type="button" id="saveSyncIntervalBtn">Save Interval</button>
                </div>
                <div id="syncIntervalMessage" class="widget-message" style="color:#047857; margin-top:8px;"></div>
            </div>
            <div id="widgetTableExplorerMessage" class="widget-message" style="color:#047857;"></div>
            <div style="overflow-x:auto;">
                <table class="widget-table" id="widgetTableExplorerTable">
                    <thead>
                        <tr>
                            <th>Widget ID</th>
                            <th>Table Status</th>
                            <th>Sync Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="widgetTableExplorerBody">
                        <tr>
                            <td colspan="4" class="empty-row">Widget IDs will appear here once the registry loads.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Additional section located after the user creation section -->
        <section class="section terms-section">
            <h2>Term Definitions</h2>
            <p>Define how prompts/responses should match saved terms. You can specify a regex or a wildcard pattern.</p>
            <form id="termCreateForm">
                <input type="hidden" id="termId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="termName">Term Name</label>
                        <input type="text" id="termName" name="name" placeholder="Term name" required>
                    </div>
                    <div class="form-group">
                        <label for="termDescription">Description</label>
                        <input type="text" id="termDescription" name="description" placeholder="What it matches"
                            required>
                    </div>
                    <div class="form-group">
                        <label for="termPattern">Match Pattern</label>
                        <input type="text" id="termPattern" name="matchPattern" placeholder="Regex or wildcard pattern">
                    </div>
                    <div class="form-group">
                        <label for="termType">Match Type</label>
                        <select id="termType" name="matchType">
                            <option value="WILDCARD">Wildcard</option>
                            <option value="REGEX">Regular Expression</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                </div>
                <div class="actions">
                    <button type="submit" id="saveTermBtn">Save Term</button>
                    <button type="button" id="cancelTermEditBtn" style="display:none;">Cancel</button>
                </div>
                <div id="termMessage" class="widget-message"></div>
            </form>
            <div style="overflow-x:auto;">
                <table class="widget-table" id="termTable">
                    <thead>
                        <tr>
                            <th>Term</th>
                            <th>Description</th>
                            <th>Pattern</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="termTableBody">
                        <tr>
                            <td colspan="5" class="empty-row">Loading terms…</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>


        <section class="section user-section">
            <h2>Create User</h2>
            <p>Only admins may create new admin or regular users. Choose the role below.</p>
            <form id="userCreateForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newUsername">Username</label>
                        <input type="text" id="newUsername" name="username" placeholder="Enter username" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Password</label>
                        <input type="password" id="newPassword" name="password" placeholder="Enter password" required>
                    </div>
                    <div class="form-group">
                        <label for="roleSelect">Role</label>
                        <select id="roleSelect" name="role">
                            <option value="USER" selected>USER</option>
                            <option value="ADMIN">ADMIN</option>
                        </select>
                    </div>
                </div>
                <div class="actions">
                    <button type="submit">Create User</button>
                </div>
                <div id="userResult" class="result" style="color:#047857;"></div>
            </form>
            <div class="user-list">
                <h3>Existing Users</h3>
                <div style="overflow-x:auto;">
                    <table class="widget-table" id="userTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr>
                                <td colspan="3" class="empty-row">Loading users…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script>
        window.adminPageConfig = {
            contextPath: '${contextPath}',
            widgetListJson: '${widgetListJson}',
            termsListJson: '${termsListJson}',
            apiKeyStored: '${apiKeyStored}'
        };
    </script>
    <script src="${contextPath}/assets/js/admin_page.js"></script>
</body>

</html>